name: Java CI/CD with Gradle and Docker

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      target_environment:
        description: "Deploy target environment"
        required: true
        type: choice
        default: production
        options:
          - development
          - staging
          - production
      image_tag:
        description: "Optional Docker image tag override (default: git SHA)"
        required: false
        type: string

permissions:
  contents: read

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Secret scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

      - name: Test with Gradle Wrapper
        run: |
          chmod +x ./gradlew
          ./gradlew clean test

  deploy:
    # Temporarily disabled until deployment infrastructure (e.g., EC2) is available.
    if: ${{ false }}
    needs: ci
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment || 'production' }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

      - name: Resolve image tag
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "image_tag=${{ github.event.inputs.image_tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "image_tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate required environment secrets
        env:
          DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_IMAGE_NAME }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_HUB_ACCESS_TOKEN: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          EC2_IP: ${{ secrets.EC2_IP }}
          EC2_SSH_USER: ${{ secrets.EC2_SSH_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          SPRING_PROFILES_ACTIVE: ${{ secrets.SPRING_PROFILES_ACTIVE }}
          DB_URL: ${{ secrets.DB_URL }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          IMP_API_SECRETKEY: ${{ secrets.IMP_API_SECRETKEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        run: |
          required=(
            DOCKER_IMAGE_NAME
            DOCKER_USERNAME
            DOCKER_HUB_ACCESS_TOKEN
            EC2_IP
            EC2_SSH_USER
            EC2_SSH_KEY
            SPRING_PROFILES_ACTIVE
            DB_URL
            DB_USERNAME
            DB_PASSWORD
            REDIS_HOST
            REDIS_PORT
            IMP_API_SECRETKEY
            JWT_SECRET_KEY
          )

          missing=0
          for name in "${required[@]}"; do
            if [ -z "${!name}" ]; then
              echo "::error::Missing required secret: ${name}"
              missing=1
            fi
          done

          if [ "$missing" -ne 0 ]; then
            exit 1
          fi

      - name: Build application jar
        run: |
          chmod +x ./gradlew
          ./gradlew clean bootJar -x test

      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKER_IMAGE_NAME }}:${{ steps.meta.outputs.image_tag }} .

      - name: Docker Hub Login
        run: echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Push Docker image (immutable tag)
        run: docker push ${{ secrets.DOCKER_IMAGE_NAME }}:${{ steps.meta.outputs.image_tag }}

      - name: Promote latest tag (production only)
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.target_environment == 'production') }}
        run: |
          docker tag ${{ secrets.DOCKER_IMAGE_NAME }}:${{ steps.meta.outputs.image_tag }} ${{ secrets.DOCKER_IMAGE_NAME }}:latest
          docker push ${{ secrets.DOCKER_IMAGE_NAME }}:latest

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_SSH_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            CONTAINER_ID=$(sudo docker ps -aq --filter "name=cofshop")

            if [ -n "$CONTAINER_ID" ]; then
              sudo docker stop $CONTAINER_ID || true
              sudo docker rm $CONTAINER_ID
            fi

            echo "${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}" | sudo docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
            sudo docker pull ${{ secrets.DOCKER_IMAGE_NAME }}:${{ steps.meta.outputs.image_tag }}

            sudo docker run --name cofshop --network my-network --restart unless-stopped -d -p 8080:8080 \
              -e TZ=Asia/Seoul \
              -e SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE != '' && secrets.SPRING_PROFILES_ACTIVE || 'prod' }} \
              -e JPA_DDL_AUTO=${{ secrets.JPA_DDL_AUTO != '' && secrets.JPA_DDL_AUTO || 'validate' }} \
              -e DB_URL=${{ secrets.DB_URL }} \
              -e DB_USERNAME=${{ secrets.DB_USERNAME }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e IMP_API_SECRETKEY=${{ secrets.IMP_API_SECRETKEY }} \
              -e PORTONE_STORE_ID=${{ secrets.PORTONE_STORE_ID }} \
              -e PORTONE_CHANNEL_KEY=${{ secrets.PORTONE_CHANNEL_KEY }} \
              -e JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }} \
              -e REDIS_HOST=${{ secrets.REDIS_HOST }} \
              -e REDIS_PORT=${{ secrets.REDIS_PORT }} \
              -e REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }} \
              -e REDIS_SSL_ENABLED=${{ secrets.REDIS_SSL_ENABLED }} \
              ${{ secrets.DOCKER_IMAGE_NAME }}:${{ steps.meta.outputs.image_tag }}

  dependency-submission:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: temurin
      - name: Generate and submit dependency graph
        uses: gradle/actions/dependency-submission@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0
